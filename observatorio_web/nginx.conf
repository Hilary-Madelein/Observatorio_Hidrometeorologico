events { }

http {
  upstream backend {
    server backend:5007;          # El nombre de tu servicio en docker-compose
  }

  server {
    listen       80;
    server_name  computacion.unl.edu.ec;

    root   /usr/share/nginx/html; # Aquí está tu build completa
    index  index.html;

    # 1) Cualquier ruta bajo /hid/ sirve tu SPA, con fallback a /hid/index.html
    location /hid/ {
      try_files $uri $uri/ /hid/index.html;
    }

    # 2) Assets estáticos (JS, CSS, imágenes, fuentes…)
    location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|woff2?|eot|ttf|svg)$ {
      expires 6M;
      access_log off;
      add_header Cache-Control "public, max-age=15552000, immutable";
      try_files $uri =404;
    }

    # 3) Proxy a tu API
    location /api/ {
      proxy_pass         http://backend/api/;
      proxy_http_version 1.1;
      proxy_set_header   Host            $host;
      proxy_set_header   X-Real-IP       $remote_addr;
      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # 4) Proxy a Socket.IO (si lo usas)
    location /socket.io/ {
      proxy_pass           http://backend/socket.io/;
      proxy_http_version   1.1;
      proxy_set_header     Upgrade        $http_upgrade;
      proxy_set_header     Connection     "Upgrade";
      proxy_set_header     Host           $host;
      proxy_cache_bypass   $http_upgrade;
    }

    # 5) En caso de 404, vuelve a servir el index de tu SPA
    error_page 404 /hid/index.html;
  }
}
