events { }

http {
  upstream backend {
    server backend:3006;  # tu servicio en docker-compose
  }

  server {
    listen       80;
    server_name  computacion.unl.edu.ec;

    # Raíz general (no se usa directamente para el SPA)
    root   /usr/share/nginx/html;
    index  index.html;

    # 1) Redirigir "/hid" a "/hid/" para que entre en el bloque SPA
    location = /hid {
      return 301 $scheme://$host/hid/;
    }

    # 2) Servir tu SPA bajo /hid/
    location /hid/ {
      # Usa “root” en vez de “alias” para que la estructura quede:
      #   /usr/share/nginx/html/hid/index.html
      root   /usr/share/nginx/html;
      index  index.html;

      # cualquier petición, primero intenta el fichero físico,
      # si no existe, devuelve /hid/index.html
      try_files $uri $uri/ /hid/index.html;
    }

    # 3) Asegurar que los assets estáticos “/static/…” se sirvan desde hid/static
    location ~ ^/hid/static/ {
      root   /usr/share/nginx/html;
      expires 6M;
      access_log off;
      add_header Cache-Control "public, max-age=15552000, immutable";
      try_files $uri =404;
    }

    # 4) Proxy a tu API sin duplicar “/api”
    location /api/ {
      proxy_pass         http://backend;             # NOTA: quita el “/api/” extra
      proxy_http_version 1.1;
      proxy_set_header   Host            $host;
      proxy_set_header   X-Real-IP       $remote_addr;
      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # 5) Proxy a Socket.IO
    location /socket.io/ {
      proxy_pass           http://backend;           # de nuevo, sin ruta adicional
      proxy_http_version   1.1;
      proxy_set_header     Upgrade        $http_upgrade;
      proxy_set_header     Connection     "Upgrade";
      proxy_set_header     Host           $host;
      proxy_cache_bypass   $http_upgrade;
    }

    # 6) En caso de 404, sirve el index de tu SPA
    error_page 404 /hid/index.html;
  }
}
